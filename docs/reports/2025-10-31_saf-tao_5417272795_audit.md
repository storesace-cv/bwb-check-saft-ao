# Relatório técnico — SAF-T (AO) 5417272795 (Setembro 2025)

## Fonte do diagnóstico
- **Ficheiro analisado**: `tests/bad-examples/SAF-T-AO_5417272795_01092025_000000_30092025_235959.xml.zip`.
- **Log de validação**: `tests/saft-error-logs/SAF-T-AO_5417272795_01092025_000000_30092025_235959_v.02_20251031T111306Z.xlsx` (12 261 registos).
- **Validador utilizado**: `validator_saft_ao.py`, motor interno descrito em `src/saftao/validator.py`.

Os resultados abaixo agregam os códigos de erro presentes no log Excel e classificam a respetiva infringência normativa ou técnica.

## Síntese executiva
- Foram detetadas **12 258 ocorrências** de não conformidade (excluindo linhas de informação).
- As falhas concentram-se em dois temas: clientes exportados com _namespace_ incorreto no MasterFiles e faturas a referenciar clientes inexistentes.
- A correção exige regenerar o MasterFiles sem o prefixo `ns:` nos identificadores e reenviar o SAF-T depois de sanear as referências cruzadas.

## 1. `CUSTOMER_WRONG_NAMESPACE`
- **Ocorrências**: 5 122.
- **Clientes afetados**: 5 122 `CustomerID` distintos (todos os clientes exportados).
- **Descrição**: o MasterFiles apresenta nós `CustomerID` com prefixo `ns:` em vez de utilizar o _namespace_ por omissão definido pelo XSD oficial `urn:OECD:StandardAuditFile-Tax:AO_1.01_01`. O validador sinaliza a divergência ao processar o bloco de clientes em `src/saftao/validator.py`.
- **Regra infringida**: o Manual Técnico do SAF-T (AO) exige consistência estrutural com o XSD oficial; IDs em MasterFiles têm de ser únicos e alinhados com os documentos emitidos.【F:docs/regras_tecnico_agt_saft-ao.md†L11-L46】
- **Consequência**: todos os clientes ficam marcados como inválidos, bloqueando a associação de faturas.
- **Ação corretiva sugerida**:
  1. Ajustar o gerador de XML para serializar `CustomerID` sem prefixos de _namespace_.
  2. Regenerar o ficheiro SAF-T e repetir a validação.

## 2. `INVOICE_CUSTOMER_MISSING`
- **Ocorrências**: 7 136.
- **Clientes envolvidos**: 5 113 identificadores distintos referenciados em faturas mas inválidos no MasterFiles.
- **Descrição**: as faturas no bloco `SourceDocuments/SalesInvoices` apontam para `CustomerID` inexistentes porque o MasterFiles rejeitou os clientes com _namespace_ incorreto, produzindo mensagens como "Fatura 'FR 2A2501/4' referencia CustomerID '220351' que não existe no MasterFiles".
- **Regra infringida**: o XSD e o Manual Técnico impõem referências cruzadas válidas entre `SalesInvoices` e o catálogo `MasterFiles` para garantir integridade dos identificadores.【F:docs/regras_tecnico_agt_saft-ao.md†L11-L46】
- **Consequência**: 7 136 faturas ficam sem cliente válido, impedindo submissão à AGT.
- **Ação corretiva sugerida**:
  1. Resolver o erro de _namespace_ no MasterFiles (ver secção anterior).
  2. Reexportar as faturas garantindo que cada `CustomerID` existe no bloco `MasterFiles/Customer`.
  3. Reexecutar a validação estrita antes da submissão.

## Riscos legais associados
O incumprimento da estrutura oficial impede a aceitação do ficheiro pela AGT e pode originar correções oficiosas ou coimas previstas no Despacho Executivo n.º 472/20, no Manual SAF-T (AO) e na legislação fiscal de suporte.【F:docs/regras_legal_agt_saft-ao.md†L3-L59】

## Recomendações para entrega à software house
1. Anexar este relatório ao pedido de correção, salientando que o problema é estrutural e impede a submissão do SAF-T.
2. Solicitar atualização urgente do exportador para remover prefixos de _namespace_ nos `CustomerID` e validar referências cruzadas antes da geração do XML.
3. Após receber nova versão do ficheiro, repetir a validação estrita e manter registo de submissão conforme obrigações legais.【F:docs/regras_legal_agt_saft-ao.md†L38-L51】
